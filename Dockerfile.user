FROM f0xedb/tos-base:latest

ARG user=tos

# Retreive the tos repo
RUN curl https://raw.githubusercontent.com/ODEX-TOS/tos-live/master/toslive/pacman.conf > /etc/pacman.conf

RUN pacman-key --init && pacman-key --populate

RUN pacman -Syu git base-devel system-updater ccat lsb-release tos-tools --noconfirm

# clear the pacman cache
RUN pacman -Sc --noconfirm

# create a user
RUN useradd $user && echo "$user ALL=(root) NOPASSWD:ALL" > /etc/sudoers.d/user && chmod 0440 /etc/sudoers.d/user && mkdir -p /home/$user && chown $user:users /home/$user

# Install yay as a user
RUN su - $user -c "git clone https://aur.archlinux.org/yay.git"

RUN su - $user -c "cd yay && makepkg -si --noconfirm && cd ../ && rm -rf yay"

# remove yay make dependency
RUN pacman -Rns go --noconfirm

# tos version
RUN curl https://raw.githubusercontent.com/ODEX-TOS/tos-live/master/toslive/version-edit.txt > /etc/version


# Setup zsh

RUN pacman -Syu zsh --noconfirm && NAME=$user su - $user -c "\
curl https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -o install.sh && \
export RUNZSH=no && \
export CHSH=no && \
sh install.sh && \
rm install.sh && \
git clone https://github.com/zsh-users/zsh-autosuggestions /home/${NAME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions && \
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git /home/${NAME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting && \
git clone https://github.com/zsh-users/zsh-completions.git /home/${NAME}/.oh-my-zsh/custom/plugins/zsh-completions && \
git clone https://github.com/ODEX-TOS/zsh-load /home/${NAME}/.oh-my-zsh/load && \
curl https://raw.githubusercontent.com/ODEX-TOS/tos-live/master/_tos >/home/${NAME}/.oh-my-zsh/custom/plugins/zsh-completions/src/_tos && \
git clone https://github.com/denysdovhan/spaceship-prompt.git /home/${NAME}/.oh-my-zsh/custom/themes/spaceship-prompt && \
ln -s /home/${NAME}/.oh-my-zsh/custom/themes/spaceship-prompt/spaceship.zsh-theme /home/${NAME}/.oh-my-zsh/custom/themes/spaceship.zsh-theme"

RUN pacman -Sc --noconfirm

RUN chsh --shell /bin/zsh $user

USER $user

CMD ["/bin/zsh"]
